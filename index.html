<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay-Mu | WANZOFC</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #4a00e0;
            --secondary-color: #8e2de2;
            --accent-color: #00bcd4;
            --background-color: #f0f2f5;
            --text-color: #333;
            --text-light: #f8f8f8;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .payment-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        #user-balance {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 0.85em;
            font-weight: 600;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .card-header {
            margin-bottom: 30px;
        }

        .card-header h1 {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .card-header h1 .mu {
            color: var(--secondary-color);
            font-style: italic;
        }

        .card-header p {
            font-size: 0.95em;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 0, 224, 0.2);
        }

         .input-group {
            position: relative;
         }
         .input-group .input-prefix {
            position: absolute;
            left: 1px;
            top: 1px;
            bottom: 1px;
            background-color: #eee;
            color: #555;
            padding: 0 12px;
            display: flex;
            align-items: center;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            border-right: 1px solid #ccc;
            font-weight: 600;
         }
         .input-group input {
             padding-left: 60px;
         }

        .btn-generate, .btn-admin {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 10px;
        }

        .btn-generate:hover, .btn-admin:hover {
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .btn-generate:active, .btn-admin:active {
             transform: translateY(0);
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        .btn-generate:disabled, .btn-admin:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .qr-code-container {
            margin-top: 30px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            background-color: #fafafa;
            transition: background-color 0.3s ease;
        }
        .qr-code-container.loading {
             background-color: #eef;
        }

        .qr-code-container img {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .qr-code-container p {
            font-size: 0.9em;
            color: #777;
        }

        .error-message {
            color: #d93025;
            font-size: 0.85em;
            margin-top: 5px;
            min-height: 1.2em;
            text-align: left;
        }
        #general-error {
            color: #d93025;
            font-weight: bold;
            margin-top: 15px;
            min-height: 1.5em;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #checkout-container {
            margin-top: 30px;
            padding: 25px 30px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
            display: none;
        }

        #checkout-container h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .checkout-info p {
            font-size: 1em;
            margin-bottom: 10px;
        }

        #timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        #timer.expired {
            color: #dc3545;
        }

        #admin-link {
           position: absolute;
           top: 15px;
           left: 15px;
           font-size: 0.85em;
           font-weight: 600;
           color: var(--primary-color);
           text-decoration: none;
           padding: 8px 15px;
           border-radius: var(--border-radius);
           background-color: rgba(255,255,255,0.9);
           box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="user-balance" class="user-balance">Saldo: Rp <span id="balance-amount">0.00</span></div>
        <a href="/admin/dashboard" id="admin-link" style="display: none;">Admin Dashboard</a>

        <div id="register-form" class="form-container" style="display:none;">
            <h1>Register</h1>
            <form id="registration-form">
                <div class="form-group">
                    <label for="register-username">Username</label>
                    <input type="text" id="register-username" name="register-username" required placeholder="Enter Username">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" name="register-password" required placeholder="Enter Password">
                </div>
                <button type="submit" class="btn-generate">Register</button>
                <p class="error-message" id="register-error"></p>
                <a href="#" onclick="showLoginForm()">Already have an account? Login</a>
            </form>
        </div>

        <div id="login-form" class="form-container" style="display:none;">
            <h1>Login</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" name="login-username" required placeholder="Enter Username">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" name="login-password" required placeholder="Enter Password">
                </div>
                <button type="submit" class="btn-generate">Login</button>
                <p class="error-message" id="login-error"></p>
                <a href="#" onclick="showRegistrationForm()">Don't have an account? Register</a>
            </form>
        </div>

        <div class="main-content" id="main-content" style="display:none;">
             <div id="profile-area" class="profile-area">
                <button id="logout-button" class="btn-generate" style="margin-top: 0;">Logout</button>
            </div>

            <div class="payment-card">
                <div class="card-header">
                    <h1>Pay<span class="mu">-Mu</span></h1>
                    <p>Generate QR Code for Your Payment</p>
                </div>

                <form id="payment-form">
                    <div class="form-group">
                        <label for="amount">Amount (IDR)</label>
                        <div class="input-group">
                            <span class="input-prefix">Rp</span>
                            <input type="number" id="amount" name="amount" placeholder="e.g., 50000" min="1" step="any" required>
                        </div>
                        <div class="error-message" id="amount-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="transactionId">Transaction ID</label>
                        <input type="text" id="transactionId" name="transactionId" placeholder="e.g., INV-12345 or Auto-Generated" required>
                        <div class="error-message" id="transactionId-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description (Optional)</label>
                        <input type="text" id="description" name="description" placeholder="e.g., Payment for Order #XYZ">
                    </div>

                     <div class="form-group">
                        <label for="payment-method">Payment Method</label>
                        <select id="payment-method" name="payment-method" required>
                            <option value="" disabled selected>Select Payment Method</option>
                            <option value="dana">DANA</option>
                            <option value="gopay">GoPay</option>
                        </select>
                        <div class="error-message" id="payment-method-error"></div>
                    </div>

                    <button type="submit" id="generate-btn" class="btn-generate">Generate Payment QR</button>
                    <div id="general-error" class="error-message" style="text-align: center; font-weight: bold;"></div>
                </form>

                <div id="qr-code-result" class="qr-code-container">
                    <p>Your payment QR code will appear here.</p>
                </div>
            </div>

            <div id="checkout-container">
                <h2>Confirm Payment</h2>
                <div class="checkout-info">
                    <p>Transaction ID: <span id="checkout-transaction-id"></span></p>
                    <p>Amount: <span id="checkout-amount"></span></p>
                    <p>Description: <span id="checkout-description"></span></p>
                    <p>Payment Method: <span id="checkout-payment-method"></span></p>
                    <p>Time remaining: <span id="timer"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const el = (id) => document.getElementById(id);

        const show = (elementId) => {
            const element = el(elementId);
            if (element) element.style.display = 'block';
        };

        const hide = (elementId) => {
            const element = el(elementId);
            if (element) element.style.display = 'none';
        };

        const showRegistrationForm = () => {
            hideAllContent();
            show('register-form');
        };

        const showLoginForm = () => {
            hideAllContent();
            show('login-form');
        };

        const showMainContent = () => {
            hideAllContent();
            show('main-content');
        };

        const hideAllContent = () => {
            hide('register-form');
            hide('login-form');
            hide('main-content');
            hide('checkout-container');
        };

        const clearError = (elementId) => {
            const errorElement = el(elementId);
            if (errorElement) errorElement.textContent = '';
        };

        const showError = (element, message) => {
            if (element) {
                element.textContent = message;
                element.style.color = '#d93025';
            }
        };

        const loadUserProfile = async () => {
            try {
                const response = await fetch('/profile');
                if (response.ok) {
                    const profileData = await response.json();
                    el('balance-amount').textContent = profileData.balance.toLocaleString('id-ID');
                    showMainContent();
                    toggleAdminLink(profileData.isAdmin);
                    return true;
                } else {
                    console.error('Failed to load profile:', response.status);
                    showLoginForm();
                    return false;
                }
            } catch (error) {
                console.error('Error fetching profile:', error);
                showLoginForm();
                return false;
            }
        };

        const toggleAdminLink = (isAdmin) => {
            const adminLink = el('admin-link');
            if (adminLink) {
                adminLink.style.display = isAdmin ? 'block' : 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const registerForm = el('registration-form');
            const loginForm = el('login-form');
            const paymentForm = el('payment-form');

            const registerError = el('register-error');
            const loginError = el('login-error');
            const generalError = el('general-error');
            const amountError = el('amount-error');
            const transactionIdError = el('transactionId-error');
            const paymentMethodError = el('payment-method-error');

            const checkoutContainer = el('checkout-container');
            const checkoutTransactionId = el('checkout-transaction-id');
            const checkoutAmount = el('checkout-amount');
            const checkoutDescription = el('checkout-description');
            const checkoutPaymentMethod = el('checkout-payment-method');
            const timerElement = el('timer');
            const qrCodeResultDiv = el('qr-code-result');

            const logoutButton = el('logout-button');
            const balanceAmount = el('balance-amount');

            const timerDuration = 60;
            let countdownInterval;

             const showLoading = () => {
                qrCodeResultDiv.innerHTML = '<div class="spinner"></div><p>Generating QR Code...</p>';
                qrCodeResultDiv.classList.add('loading');
                if(paymentForm) {
                   paymentForm.querySelector('#generate-btn').disabled = true;
                   paymentForm.querySelector('#generate-btn').textContent = 'Generating...';
                }
             };

             const hideLoading = () => {
                 qrCodeResultDiv.classList.remove('loading');
                 if(paymentForm) {
                     paymentForm.querySelector('#generate-btn').disabled = false;
                     paymentForm.querySelector('#generate-btn').textContent = 'Generate Payment QR';
                }
             };

            const generateUniqueId = () => `PM-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;

            if (registerForm) {
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    clearError('register-error');
                    const username = el('register-username').value.trim();
                    const password = el('register-password').value.trim();
                    if (!username || !password) {
                        showError(registerError, 'Username and password are required.');
                        return;
                    }
                    try {
                        const response = await fetch('/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password }),
                        });
                        if (response.ok) {
                            alert('Registration successful! Please login.');
                            showLoginForm();
                        } else {
                            const errorData = await response.json();
                            showError(registerError, errorData.error || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Registration Error:', error);
                        showError(registerError, 'Registration failed. Check console.');
                    }
                });
            }

            if (loginForm) {
                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    clearError('login-error');
                    const username = el('login-username').value.trim();
                    const password = el('login-password').value.trim();

                    if (!username || !password) {
                        showError(loginError, 'Username and password are required.');
                        return;
                    }

                    try {
                        const response = await fetch('/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password }),
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('Login successful:', data);
                            if (data.isAdmin) {
                                sessionStorage.setItem('isAdmin', 'true');
                            }
                            loadUserProfile();
                        } else {
                            const errorData = await response.json();
                            showError(loginError, errorData.error || 'Invalid credentials');
                        }
                    } catch (error) {
                        console.error('Login Error:', error);
                        showError(loginError, 'Login failed. Check console.');
                    }
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/logout', { method: 'POST' });
                        if (response.ok) {
                            sessionStorage.removeItem('isAdmin');
                            showLoginForm();
                        } else {
                            console.error('Logout failed');
                            alert('Logout failed');
                        }
                    } catch (error) {
                        console.error('Logout error', error);
                        alert('Logout failed. Check the console.');
                    }
                });
            }

            if (paymentForm) {
                paymentForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    clearError('amount-error');
                    clearError('transactionId-error');
                    clearError('payment-method-error');
                    const amount = el('amount').value;
                    const transactionId = el('transactionId').value;
                    const description = el('description').value;
                    const paymentMethod = el('payment-method').value;

                    // --- Validation (Client-Side)---
                     let isValid = true;
                     if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                         showError(amountError, 'Please enter a valid amount.');
                         isValid = false;
                     }
                     if (!transactionId) {
                         showError(transactionIdError, 'Transaction ID is required.');
                         isValid = false;
                     }
                     if (!paymentMethod) {
                          showError(paymentMethodError, 'Please select a payment method.');
                          isValid = false;
                      }

                    if (!isValid) {
                        return;
                    }
                    // --- End Validation ---

                    showLoading();

                    try {
                        const response = await fetch('/api/allpay-qr', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                amount: amount,
                                transactionId: transactionId,
                                description: description,
                                paymentMethod: paymentMethod,
                            })
                        });

                        if (!response.ok) {
                           const errorData = await response.json();
                           throw new Error(`HTTP error! Status: ${response.status}.  ${errorData.error || ''}`);
                        }

                        const data = await response.json();
                        hideLoading();
                        qrCodeResultDiv.innerHTML = `
                           <img src="data:image/png;base64,${data.qrCode}" alt="Pay-Mu Payment QR Code">
                           <p>Scan to pay ${data.currency} ${parseFloat(data.amount).toLocaleString('id-ID')}</p>
                           <p style="font-size: 0.8em; color: #999;">ID: ${data.transactionId}</p>
                        `;

                        checkoutTransactionId.textContent = data.transactionId;
                        checkoutAmount.textContent = `${data.currency} ${parseFloat(data.amount).toLocaleString('id-ID')}`;
                        checkoutDescription.textContent = data.description || 'No Description';
                        checkoutPaymentMethod.textContent = data.paymentMethod;

                        show('checkout-container');

                    } catch (error) {
                         hideLoading();
                         console.error("Error fetching QR code:", error);
                         qrCodeResultDiv.innerHTML = '<p style="color: #d93025;">Could not generate QR code. Please check your input or try again later.</p>';
                         generalError.textContent = 'Failed to load QR Code from server.  Check the console for more details';
                    }
                });
            }

            // ---- Checkout timer ----
             const startTimer = () => {
                 let timeLeft = timerDuration;
                 timerElement.textContent = timeLeft;

                 countdownInterval = setInterval(() => {
                     timeLeft--;
                     timerElement.textContent = timeLeft;

                     if (timeLeft <= 10) {
                        timerElement.classList.add('expired');
                     }
                     if (timeLeft <= 0) {
                         clearInterval(countdownInterval);
                         timerElement.textContent = 'Expired';
                         qrCodeResultDiv.innerHTML = '<p style="color: #d93025; font-weight: bold;">Transaction Expired</p>';
                         qrCodeResultDiv.style.display = 'block';
                         checkoutContainer.style.display = 'none';
                     }
                 }, 1000);
             };

             const stopTimer = () => {
                clearInterval(countdownInterval);
             };

            // Automatically start on load or after a successful QR generation
            const isLoggedIn = loadUserProfile(); // Automatically load the user profile
            if (isLoggedIn) {
               showMainContent(); // Menampilkan halaman utama
            } else {
               showLoginForm();
            }
        });
    </script>
</body>
</html>
